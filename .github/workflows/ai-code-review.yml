name: 🤖 Qodo PR-Agent Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created, edited]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["🔍 SonarCloud PR Analysis", "🚀 Essential CI/CD"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-agent:
    name: 🤖 AI Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: (github.event_name == 'pull_request' && github.event.pull_request.draft == false) || github.event_name == 'issue_comment' || github.event_name == 'workflow_dispatch'

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332

      - name: 🤖 PR Agent Review
        if: (github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')) || github.event_name == 'workflow_dispatch' || github.event_name == 'issue_comment'
        uses: Codium-ai/pr-agent@main
        env:
          OPENAI_KEY: ""
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number || github.event.issue.number }}
        with:
          command: "review --pr_reviewer.add_original_user_description=true"

      - name: 🤖 PR Agent Review (Security Trigger)
        if: github.event_name == 'workflow_run' || github.event_name == 'check_suite'
        uses: Codium-ai/pr-agent@main
        env:
          OPENAI_KEY: ""
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: "review --pr_reviewer.security_focus=true --pr_reviewer.add_original_user_description=true"

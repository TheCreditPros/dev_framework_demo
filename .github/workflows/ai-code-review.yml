name: 🤖 Qodo PR-Agent Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created, edited]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["🔍 SonarCloud PR Analysis", "🚀 Essential CI/CD"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-agent:
    name: 🤖 AI Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: 🤖 PR Agent Review
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')
        uses: Codium-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          command: "review --pr_reviewer.add_original_user_description=true"

      - name: 🤖 PR Agent Review (Security Trigger)
        if: github.event_name == 'workflow_run' || github.event_name == 'check_suite'
        uses: Codium-ai/pr-agent@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: "review --pr_reviewer.security_focus=true --pr_reviewer.add_original_user_description=true"

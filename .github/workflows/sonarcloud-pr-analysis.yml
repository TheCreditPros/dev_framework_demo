name: ğŸ” SonarCloud PR Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

concurrency:
  group: sonarcloud-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  sonarcloud:
    name: ğŸ” SonarCloud Analysis
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]' && github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run tests with coverage
        run: npm run test:coverage

      - name: ğŸ” Run SonarCloud Analysis
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarqube-scan-action@v5.3.1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.organization=${{ vars.SONAR_ORGANIZATION || 'thecreditpros' }}
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY || github.repository }}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverageReportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.js,**/*.test.ts,**/*.spec.js,**/*.spec.ts,**/node_modules/**,**/dist/**,**/build/**
            -Dsonar.qualitygate.wait=false
            -Dsonar.qualitygate.timeout=300
            -Dsonar.verbose=false
            -Dsonar.pullrequest.provider=github
            -Dsonar.pullrequest.github.repository=${{ github.repository }}
            -Dsonar.pullrequest.github.summaryComment=true
            -Dsonar.pullrequest.github.summaryComment.enabled=true

      - name: ğŸ“‹ SonarCloud Status Summary
        if: always()
        run: |
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "âš ï¸ SONAR_TOKEN not configured - SonarCloud analysis skipped"
            echo "ğŸ“‹ This is expected for repositories without SonarCloud setup"
            echo "ğŸ” For full analysis, configure SONAR_TOKEN in repository secrets"
            echo "âœ… Build continues without SonarCloud analysis"
          elif [[ "${{ github.actor }}" == "dependabot[bot]" ]]; then
            echo "ğŸ¤– Dependabot PR detected - SonarCloud analysis skipped"
            echo "ğŸ“‹ Dependabot PRs are excluded from quality analysis"
            echo "âœ… Build continues without SonarCloud analysis"
          else
            echo "âœ… SonarCloud analysis completed successfully"
            echo "ğŸ“‹ Check the PR comments for detailed analysis results"
          fi
